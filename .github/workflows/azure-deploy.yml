# GitHub Actions workflow for deploying to Azure App Service
name: Deploy to Azure App Service

# íŠ¸ë¦¬ê±° ì¡°ê±´: main ë¸Œëœì¹˜ì— pushë˜ê±°ë‚˜ ìˆ˜ë™ìœ¼ë¡œ ì‹¤í–‰í•  ë•Œ
on:
  push:
    branches:
      - main
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

# í™˜ê²½ ë³€ìˆ˜
env:
  AZURE_WEBAPP_NAME: 'emotion-theater'  # Azure App Service ì´ë¦„ (ë³€ê²½ í•„ìš”)
  AZURE_WEBAPP_PACKAGE_PATH: 'emotion-theater-backend'  # ë°°í¬í•  í´ë”
  NODE_VERSION: '18.x'  # Node.js ë²„ì „

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    name: Build and Deploy

    steps:
    # 1. ì½”ë“œ ì²´í¬ì•„ì›ƒ
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    # 2. Node.js ì„¤ì •
    - name: ğŸ”§ Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}

    # 3. ë°±ì—”ë“œ ì˜ì¡´ì„± ì„¤ì¹˜ (í”„ë¡œë•ì…˜ ì „ìš©)
    - name: ğŸ“¦ Install backend dependencies
      working-directory: ${{ env.AZURE_WEBAPP_PACKAGE_PATH }}
      run: |
        npm ci --production
        echo "Dependencies installed successfully"
        ls -la node_modules | head -20

    # 4. ë°°í¬ ì¤€ë¹„ (ë¶ˆí•„ìš”í•œ íŒŒì¼ ì œê±°)
    - name: ğŸ§¹ Clean up
      working-directory: ${{ env.AZURE_WEBAPP_PACKAGE_PATH }}
      run: |
        echo "Removing temporary files..."
        rm -rf temp/
        rm -rf test/
        rm -rf bin/
        echo "Cleanup completed. node_modules included, ffmpeg will be installed during first start."

    # 5. Azure App Serviceì— ë°°í¬
    - name: ğŸš€ Deploy to Azure Web App
      uses: azure/webapps-deploy@v2
      with:
        app-name: ${{ env.AZURE_WEBAPP_NAME }}
        publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
        package: ${{ env.AZURE_WEBAPP_PACKAGE_PATH }}

    # 6. ë°°í¬ ì™„ë£Œ ì•Œë¦¼
    - name: âœ… Deployment completed
      run: |
        echo "ğŸ‰ Deployment to Azure completed successfully!"
        echo "ğŸŒ App URL: https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net"
